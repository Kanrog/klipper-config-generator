<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Klipper Config Generator</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: system-ui, sans-serif; background: var(--bg); padding: 20px; }
        .wrapper { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .panel { background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; color: #475569; }
        select, input { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; }
        textarea { width: 100%; height: 600px; font-family: 'Fira Code', monospace; background: #0f172a; color: #f1f5f9; padding: 15px; border-radius: 8px; border: none; font-size: 0.85rem; line-height: 1.5; }
        button { width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
        .btn-gen { background: var(--primary); color: white; }
        .btn-dl { background: #10b981; color: white; }
        button:hover { filter: brightness(1.1); }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="panel">
        <h2>üõ†Ô∏è Generator</h2>
        
        <div class="input-group">
            <label>Detected Board</label>
            <select id="boardSelect"><option>Fetching files...</option></select>
        </div>

        <div class="input-group">
            <label>Bed Size (X / Y / Z)</label>
            <div style="display: flex; gap: 8px;">
                <input type="number" id="bedX" value="235">
                <input type="number" id="bedY" value="235">
                <input type="number" id="bedZ" value="250">
            </div>
        </div>

        <div class="input-group">
            <label><input type="checkbox" id="hasBLTouch"> Add BLTouch Section</label>
        </div>

        <button class="btn-gen" onclick="generate()">Generate Config</button>
        <button class="btn-dl" onclick="download()">Download .cfg</button>
    </div>

    <div class="panel">
        <textarea id="output" readonly></textarea>
    </div>
</div>

<script>
    const CONFIG_URL = "https://api.github.com/repos/Kanrog/klipper-config-generator/contents/config-examples";

    // Auto-populate boards from the repo
    window.onload = async () => {
        const select = document.getElementById('boardSelect');
        try {
            const resp = await fetch(CONFIG_URL);
            const files = await resp.json();
            select.innerHTML = '';
            files.forEach(f => {
                if(f.name.endsWith('.cfg')) {
                    const opt = document.createElement('option');
                    opt.value = f.name;
                    opt.textContent = f.name.replace('generic-', '').replace('.cfg', '').replace(/-/g, ' ').toUpperCase();
                    select.appendChild(opt);
                }
            });
        } catch (e) {
            select.innerHTML = '<option>Error: check API rate limit</option>';
        }
    };

    async function generate() {
        const file = document.getElementById('boardSelect').value;
        const x = document.getElementById('bedX').value;
        const y = document.getElementById('bedY').value;
        const z = document.getElementById('bedZ').value;

        const resp = await fetch(`./config-examples/${file}`);
        const raw = await resp.text();

        // Robust Pin Scraper
        const getPin = (section, key) => {
            const regex = new RegExp(`\\[${section}\\][\\s\\S]*?${key}:\\s*(\\S+)`, 'i');
            const match = raw.match(regex);
            return match ? match[1] : "PA0_FIXME";
        };

        let cfg = `# Generated for ${file}\n\n`;
        cfg += `[mcu]\nserial: /dev/serial/by-id/usb-Klipper_REPLACE_ME\n\n`;
        cfg += `[printer]\nkinematics: cartesian\nmax_velocity: 300\nmax_accel: 3000\n\n`;

        // X Stepper
        cfg += `[stepper_x]\nstep_pin: ${getPin('stepper_x', 'step_pin')}\ndir_pin: ${getPin('stepper_x', 'dir_pin')}\nenable_pin: ${getPin('stepper_x', 'enable_pin')}\nmicrosteps: 16\nrotation_distance: 40\nendstop_pin: ${getPin('stepper_x', 'endstop_pin')}\nposition_endstop: 0\nposition_max: ${x}\nhoming_speed: 50\n\n`;

        // Y Stepper
        cfg += `[stepper_y]\nstep_pin: ${getPin('stepper_y', 'step_pin')}\ndir_pin: ${getPin('stepper_y', 'dir_pin')}\nenable_pin: ${getPin('stepper_y', 'enable_pin')}\nmicrosteps: 16\nrotation_distance: 40\nendstop_pin: ${getPin('stepper_y', 'endstop_pin')}\nposition_endstop: 0\nposition_max: ${y}\nhoming_speed: 50\n\n`;

        document.getElementById('output').value = cfg;
    }

    function download() {
        const text = document.getElementById('output').value;
        const blob = new Blob([text], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "printer.cfg";
        a.click();
    }
</script>
</body>
</html>
