<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Klipper Config Generator v2</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --card: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .wrapper { display: grid; grid-template-columns: 350px 1fr; gap: 20px; width: 100%; max-width: 1200px; }
        .panel { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #64748b; }
        select, input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        textarea { width: 100%; height: 600px; font-family: monospace; background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 4px; border: none; }
        button { width: 100%; padding: 10px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; margin-bottom: 10px; }
        .btn-gen { background: var(--primary); color: white; }
        .btn-dl { background: #10b981; color: white; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="panel">
        <h2>üõ†Ô∏è Settings</h2>
        
        <div class="input-group">
            <label>Motherboard</label>
            <select id="boardSelect"><option>Loading boards...</option></select>
        </div>

        <div class="input-group">
            <label>Printer Name</label>
            <input type="text" id="printerName" value="My Custom Printer">
        </div>

        <div class="input-group">
            <label>Dimensions (X, Y, Z)</label>
            <div style="display: flex; gap: 5px;">
                <input type="number" id="bedX" value="235">
                <input type="number" id="bedY" value="235">
                <input type="number" id="bedZ" value="250">
            </div>
        </div>

        <div class="input-group">
            <label><input type="checkbox" id="hasBLTouch"> Include BLTouch</label>
        </div>

        <button class="btn-gen" onclick="generate()">Generate Preview</button>
        <button class="btn-dl" onclick="download()">Download printer.cfg</button>
    </div>

    <div class="panel">
        <textarea id="output" readonly placeholder="Output will appear here..."></textarea>
    </div>
</div>

<script>
    // 1. Auto-populate dropdown on load
    window.onload = async () => {
        const select = document.getElementById('boardSelect');
        try {
            const resp = await fetch('boards.json');
            const data = await resp.json();
            select.innerHTML = ''; // Clear loading message
            data.boards.forEach(b => {
                let opt = document.createElement('option');
                opt.value = b.file;
                opt.textContent = b.name;
                select.appendChild(opt);
            });
        } catch (e) {
            select.innerHTML = '<option>Error loading boards.json</option>';
        }
    };

    async function generate() {
        const boardFile = document.getElementById('boardSelect').value;
        const name = document.getElementById('printerName').value;
        const x = document.getElementById('bedX').value;
        const y = document.getElementById('bedY').value;
        const z = document.getElementById('bedZ').value;
        const blt = document.getElementById('hasBLTouch').checked;

        try {
            const resp = await fetch(`./config-examples/${boardFile}`);
            const raw = await resp.text();

            // Extract [board_pins]
            const pinMatch = raw.match(/\[board_pins\][\s\S]*?aliases:([\s\S]*?)(?=\n\[|$)/);
            const aliases = pinMatch ? pinMatch[1].trim() : "# No aliases found in source";

            let cfg = `# ${name}\n# Generated via Custom Klipper Configurator\n\n`;
            cfg += `[mcu]\nserial: /dev/serial/by-id/usb-Klipper_REPLACE_ME\n\n`;
            cfg += `[printer]\nkinematics: cartesian\nmax_velocity: 300\nmax_accel: 3000\n\n`;
            cfg += `[board_pins]\naliases:\n    ${aliases}\n\n`;
            
            // X Stepper Logic
            cfg += `[stepper_x]\nstep_pin: PB13\ndir_pin: !PB12\nenable_pin: !PB14\nmicrosteps: 16\nrotation_distance: 40\nendstop_pin: ^PC0\nposition_endstop: 0\nposition_max: ${x}\nhoming_speed: 50\n\n`;
            
            if(blt) {
                cfg += `[bltouch]\nsensor_pin: ^PC14\ncontrol_pin: PA1\nx_offset: -40\ny_offset: -10\nz_offset: 0\n\n`;
            }

            document.getElementById('output').value = cfg;
        } catch (e) {
            alert("Fetch failed. Make sure the file exists in /config-examples/");
        }
    }

    function download() {
        const blob = new Blob([document.getElementById('output').value], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "printer.cfg";
        a.click();
    }
</script>
</body>
</html>